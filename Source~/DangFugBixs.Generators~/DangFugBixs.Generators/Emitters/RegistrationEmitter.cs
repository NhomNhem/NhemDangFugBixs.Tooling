using System.CodeDom.Compiler;
using System.Text;
using System.Linq;
using NhemDangFugBixs.Common.Models;
using NhemDangFugBixs.Generators.Utils;

namespace NhemDangFugBixs.Generators.Emitters;

internal static class RegistrationEmitter {
    public static string GenerateSource(IEnumerable<ServiceInfo> services, IEnumerable<SceneInjectionInfo> sceneServices) {
        using var stringWriter = new StringWriter();
        using var writer = new IndentedTextWriter(stringWriter, "    ");
        
        // 1. Header 
        writer.WriteLine("// <auto-generated />");
        writer.WriteLine("// Generated by NhemDangFugBixs.Tooling");
        writer.WriteLine();
        writer.WriteLine("using System;");
        writer.WriteLine("using VContainer;");
        writer.WriteLine("using VContainer.Unity;");
        writer.WriteLine();
        
        using (writer.Block("namespace NhemDangFugBixs.Generated")) {
            
            // 1. Blueprint for Editor Discovery (Professional Scene-to-DI mapping)
            using (writer.Block("public static class SceneInjectionBlueprint")) {
                writer.WriteLine("public static readonly Type[] ComponentTypes = {");
                writer.Indent++;
                foreach (var svc in sceneServices) {
                    writer.WriteLine($"typeof({svc.FullName}),");
                }
                writer.Indent--;
                writer.WriteLine("};");
            }
            writer.WriteLine();

            // 2. Standard VContainer Registrations
            using (writer.Block("public static class VContainerRegistration")) {
                
                var groups = services.GroupBy(s => s.ScopeName);

                foreach (var group in groups) {
                    string methodName = $"Register{group.Key}"; 
                    
                    using (writer.Block($"public static void {methodName}(IContainerBuilder builder)")) {
                        foreach (var svc in group) {
                            var interfaces = svc.InterfaceNames;
                            bool isEntryPoint = interfaces.Any(i => i == "VContainer.Unity.IInitializable" || 
                                                                   i == "VContainer.Unity.ITickable" || 
                                                                   i == "VContainer.Unity.IFixedTickable" || 
                                                                   i == "VContainer.Unity.ILateTickable" || 
                                                                   i == "VContainer.Unity.IStartable" || 
                                                                   i == "VContainer.Unity.IPostInitializable" || 
                                                                   i == "VContainer.Unity.IPostTickable" || 
                                                                   i == "VContainer.Unity.IPostFixedTickable" || 
                                                                   i == "VContainer.Unity.IPostLateTickable" || 
                                                                   i == "VContainer.Unity.IPostStartable");

                            if (svc.IsComponent) {
                                writer.WriteLine($"builder.RegisterComponentInHierarchy<{svc.FullName}>();");
                            } else if (isEntryPoint) {
                                if (interfaces.Length > 0) {
                                    string interfaceList = string.Join(", ", interfaces);
                                    writer.WriteLine($"builder.RegisterEntryPoint<{svc.FullName}>().As<{interfaceList}>().WithLifetime(Lifetime.{svc.Lifetime});");
                                } else {
                                    writer.WriteLine($"builder.RegisterEntryPoint<{svc.FullName}>(Lifetime.{svc.Lifetime});");
                                }
                            } else {
                                if (interfaces.Length > 0) {
                                    string interfaceList = string.Join(", ", interfaces);
                                    writer.WriteLine($"builder.Register<{svc.FullName}>(Lifetime.{svc.Lifetime}).As<{interfaceList}>();");
                                } else {
                                    writer.WriteLine($"builder.Register<{svc.FullName}>(Lifetime.{svc.Lifetime});");
                                }
                            }
                        }
                    }
                    writer.WriteLine();
                }
            }
        }
        return stringWriter.ToString();
    }
}